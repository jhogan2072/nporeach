<h1><%= @page_title = t('.viewsubscription') %></h1>
<%= link_to(t('admin.subscriptions.edit.editsubscription'), :action => 'edit') %>
<table id="subscription">
  <tr>
    <th>Account</th>
    <td><%= link_to(h(@subscription.subscriber), [:admin, @subscription.subscriber]) %></td>
  </tr>
  <tr>
    <th>Amount</th>
    <td><%= number_to_currency(@subscription.amount) %></td>
  </tr>
  <tr>
    <th>Created</th>
    <td><%= @subscription.created_at.to_s(:short_day) %></td>
  </tr>
  <tr class="<%= 'expired' unless @subscription.current? %>">
    <th>Next Renewal</th>
    <td><%= @subscription.next_renewal_at.to_s(:short_day) %></td>
  </tr>
  <tr>
    <th>Plan</th>
    <td><%= link_to(@subscription.subscription_plan, [:admin, @subscription.subscription_plan]) %></td>
  </tr>
  <tr>
    <th>Discount</th>
    <td><%= @subscription.discount ? "#{@subscription.discount.name} (#{@subscription.discount.code}) - #{discount_label(@subscription.discount)}" : 'None' %></td>
  </tr>
  <tr>
    <th>State</th>
    <td><%= @subscription.state %></td>
  </tr>
</table>

<h2><%= t('.chargesubscription') %></h2>
<p>
  <%= t('.usethisform') %>
</p>
<% if @subscription.errors.any? %>
<div class="errorExplanation" id="errorExplanation">
  <h3><%= t('.errorswhilecharging') %></h3>
  <ul>
    <%= raw(@subscription.errors.full_messages.map {|e| content_tag(:li, h(e))}) %>
  </ul>
</div>
<% end %>

<%= form_tag({:action => 'charge'}, :id => 'charge_form', :onsubmit => 'return checkForm()') do %>
  <label>Amount</label>
  <input type="text" name="amount" id="amount" />
  <input type="submit" value="<%= t('.chargecard') %>" />
<% end %>

<h2>Transactions</h2>
<table id="transactions">
  <tr>
    <th><%= t('.date') %></th>
    <th><%= t('.amount') %></th>
    <th><%= t('.transactionid') %></th>
  </tr>
  <% @subscription.subscription_payments.each do |payment| %>
    <tr>
      <td><%= payment.created_at.to_s(:short_day) %></td>
      <td><%= number_to_currency(payment.amount) %></td>
      <td><%= payment.transaction_id %></td>
    </tr>
  <% end %>
</table>

<% content_for :head do -%>
  <script type="text/javascript" charset="utf-8">
    function checkForm() {
      amt = document.getElementById('amount')
      amt.value = amt.value.replace(/[\$,]/g, '')
      to_charge = parseInt(amt.value)
      if (isNaN(to_charge) || to_charge <= 0) {
        alert("<%= t('.pleaseenter') %>")
        return false
      }
      return confirm(<%= t('.areyousure') %>  + <%= t('number.currency.format.unit') %> + to_charge)
    }
  </script>
<% end -%>
